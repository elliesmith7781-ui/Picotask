<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picotask Admin Panel (Environment Ready)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .task-item {
            border-left-width: 4px;
        }
        .status-pending { border-color: #f59e0b; }
        .status-approved { border-color: #10b981; }
        .status-rejected { border-color: #ef4444; }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Login Modal (Displayed by default) -->
    <div id="loginGate" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-extrabold text-indigo-600 mb-4">Admin Access</h2>
            <p class="text-gray-600 mb-6">Enter the administrator password to continue.</p>
            <form id="loginForm">
                <input type="password" id="adminPassword" placeholder="Password" class="w-full border border-gray-300 rounded-md p-3 mb-4 focus:ring-indigo-500 focus:border-indigo-500" required>
                <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 font-semibold">
                    Login
                </button>
                <p id="loginMessage" class="mt-4 text-center text-sm text-red-500 hidden"></p>
            </form>
        </div>
    </div>
    
    <!-- Task Details Modal (Hidden by default) -->
    <div id="taskDetailsModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 invisible opacity-0" onclick="hideTaskDetails()">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4 transform translate-y-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold text-gray-800">Task Details</h3>
                <button onclick="hideTaskDetails()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modalDetailsContent" class="space-y-4 text-gray-700">
                <!-- Details will be injected here -->
            </div>
            <div class="mt-6 pt-4 border-t flex justify-end">
                <button onclick="hideTaskDetails()" class="py-2 px-4 border border-transparent rounded-md text-sm font-medium text-indigo-600 bg-indigo-100 hover:bg-indigo-200 transition duration-150">
                    Close
                </button>
            </div>
        </div>
    </div>


    <!-- Main Dashboard Content -->
    <div id="dashboardContainer" class="hidden">
        <!-- Main Navigation/Header -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600">
                    Picotask Admin
                </h1>
                <div id="authStatus" class="text-sm text-gray-500 flex items-center">
                    <span class="mr-2">User ID:</span>
                    <span id="userIdDisplay" class="font-mono bg-gray-100 px-2 py-1 rounded text-xs text-gray-700 truncate w-24 sm:w-auto">...</span>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Task Management Dashboard</h2>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center p-10 text-lg font-medium text-indigo-500">
                Initializing Firebase & Security Check...
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="hidden">

                <!-- Task Management Section -->
                <section class="mb-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Pending and Reviewed Tasks</h3>
                    <div id="tasksList" class="space-y-4">
                        <p class="text-gray-500">Loading tasks...</p>
                    </div>
                </section>

                <!-- Configuration Editor Section -->
                <section>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4 mt-8">Website Content Configuration (Private)</h3>
                    <div class="card bg-white p-6 rounded-xl border border-gray-100">
                        <p class="text-sm text-gray-500 mb-4">
                            These private settings control your main website's presentation (e.g., promotional text).
                        </p>
                        <form id="contentForm">
                            <div class="mb-4">
                                <label for="mainTitle" class="block text-sm font-medium text-gray-700 mb-1">Main Site Title (H1)</label>
                                <input type="text" id="mainTitle" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500" required>
                            </div>
                            <button type="submit" id="saveButton" class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                                Save Config
                            </button>
                            <p id="saveMessage" class="mt-2 text-sm text-green-600 hidden">Settings updated successfully!</p>
                        </form>
                    </div>
                </section>

                <!-- Password Change Section -->
                <section class="mt-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Admin Password Management</h3>
                    <div class="card bg-white p-6 rounded-xl border border-gray-100">
                        <p class="text-sm text-gray-500 mb-4">
                            Change the administrator access password. The default password is **Farsin Admin**.
                        </p>
                        <form id="passwordChangeForm">
                            <div class="mb-4">
                                <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                <input type="password" id="currentPassword" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3" required>
                            </div>
                            <div class="mb-4">
                                <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">New Password (Min 6 characters)</label>
                                <input type="password" id="newPassword" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3" required>
                            </div>
                            <button type="submit" id="changePasswordButton" class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                                Change Password
                            </button>
                            <p id="passwordChangeMessage" class="mt-2 text-sm text-green-600 hidden"></p>
                        </form>
                    </div>
                </section>

            </div>

            <!-- Error/Message Display -->
            <div id="messageBox" class="hidden fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-xl max-w-xs transition-opacity duration-300">
                <p id="messageText"></p>
            </div>

        </main>
    </div>

    <!-- Firebase Initialization and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Global Firebase variables
        let db, auth;
        let userId = null;
        let appId = null; 
        const CONFIG_DOC_PATH = "website_settings/live_config";
        const TASKS_COLLECTION_PATH = "tasks"; 

        // Global state for admin key (loaded from Firestore)
        let adminSecretKey = "Farsin Admin"; 

        // DOM Elements
        const loginGate = document.getElementById('loginGate');
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const dashboardContent = document.getElementById('dashboardContent');
        const contentForm = document.getElementById('contentForm');
        const mainTitleInput = document.getElementById('mainTitle');
        const saveButton = document.getElementById('saveButton');
        const saveMessage = document.getElementById('saveMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const tasksList = document.getElementById('tasksList');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const passwordChangeForm = document.getElementById('passwordChangeForm');
        const passwordChangeMessage = document.getElementById('passwordChangeMessage');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const taskDetailsModal = document.getElementById('taskDetailsModal');
        const modalDetailsContent = document.getElementById('modalDetailsContent');


        // --- Utility Functions ---

        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl max-w-xs transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- Path Builders ---

        function getConfigDocRef(uid) {
            // Path: /artifacts/{appId}/users/{uid}/website_settings/live_config (Private settings)
            return doc(db, 'artifacts', appId, 'users', uid, CONFIG_DOC_PATH);
        }

        function getTasksCollectionRef() {
            // Path: /artifacts/{appId}/public/data/tasks (Public tasks)
            return collection(db, 'artifacts', appId, 'public', 'data', TASKS_COLLECTION_PATH);
        }

        function getTaskDocRef(taskId) {
            return doc(db, 'artifacts', appId, 'public', 'data', TASKS_COLLECTION_PATH, taskId);
        }

        // --- Authentication & Initialization ---

        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            loginMessage.classList.add('hidden');

            if (password === adminSecretKey) {
                loginGate.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                dashboardContent.classList.remove('hidden');
                // Start real-time data listeners now that we are authenticated
                startDataListeners(userId);
                showMessage("Login successful. Welcome, Admin!");
            } else {
                loginMessage.textContent = "Incorrect password. Please try again.";
                loginMessage.classList.remove('hidden');
            }
        }

        async function loadAdminKey(uid) {
            try {
                const configDocRef = getConfigDocRef(uid);
                const docSnap = await getDoc(configDocRef);

                if (docSnap.exists() && docSnap.data().adminSecretKey) {
                    adminSecretKey = docSnap.data().adminSecretKey;
                } else {
                    // If no key exists, set the default key and save it
                    await setDoc(configDocRef, { adminSecretKey: adminSecretKey }, { merge: true });
                }

                loadingIndicator.classList.add('hidden');
                loginGate.classList.remove('hidden'); // Show login gate after successful connection and key check

            } catch(error) {
                 console.error("Error loading admin key:", error);
                 loadingIndicator.textContent = 'Error loading admin settings. Check console.';
            }
        }


        async function initializeFirebase() {
            loadingIndicator.textContent = "Connecting to Firebase...";

            try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (!firebaseConfig.apiKey) { throw new Error("Firebase configuration is missing."); }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // CRITICAL: onAuthStateChanged listener handles the rest of the flow
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // Once authenticated, load the admin key from the user's private config
                        loadAdminKey(userId);
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'Auth Error';
                        loadingIndicator.textContent = 'Authentication failed. Restart application.';
                        showMessage("Authentication failed.", true);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingIndicator.textContent = `Error initializing Firebase: ${error.message}`;
                showMessage(`Error: ${error.message}`, true);
            }
        }

        // --- Data Handling ---

        function startDataListeners(uid) {
            // 1. Listen to Private Config (Title, adminSecretKey, etc.)
            onSnapshot(getConfigDocRef(uid), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    mainTitleInput.value = data.mainTitle || '';

                    if (data.adminSecretKey) {
                        adminSecretKey = data.adminSecretKey;
                    }
                } else {
                    mainTitleInput.value = "Picotask: Your Tiny Task Manager";
                }
            }, (error) => {
                console.error("Config Snapshot Error:", error);
                showMessage("Failed to load private config.", true);
            });

            // 2. Listen to Public Tasks
            const tasksQuery = query(getTasksCollectionRef());

            onSnapshot(tasksQuery, (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                renderTasks(tasks);
            }, (error) => {
                console.error("Tasks Snapshot Error:", error);
                showMessage("Failed to load tasks.", true);
            });
        }

        async function saveConfig(settings, silent = false) {
            if (!db || !userId) {
                showMessage("Database connection not ready.", true);
                return;
            }
            if (!silent) {
                saveButton.textContent = 'Saving...';
                saveButton.disabled = true;
                saveMessage.classList.add('hidden');
            }

            try {
                await setDoc(getConfigDocRef(userId), settings, { merge: true });

                if (!silent) {
                    saveMessage.textContent = 'Config updated successfully!';
                    saveMessage.classList.remove('hidden');
                    showMessage("Website config updated!");
                }
            } catch (e) {
                console.error("Error saving config: ", e);
                if (!silent) {
                    saveMessage.textContent = 'Error saving config: ' + e.message;
                    saveMessage.classList.remove('hidden');
                    showMessage("Failed to save config.", true);
                }
            } finally {
                if (!silent) {
                    saveButton.textContent = 'Save Config';
                    saveButton.disabled = false;
                    setTimeout(() => saveMessage.classList.add('hidden'), 3000);
                }
            }
        }

        async function changePassword() {
            if (!db || !userId) {
                showMessage("Database connection not ready.", true);
                return;
            }

            const current = currentPasswordInput.value;
            const newPass = newPasswordInput.value;

            passwordChangeMessage.classList.add('hidden');
            changePasswordButton.textContent = 'Changing...';
            changePasswordButton.disabled = true;

            if (current !== adminSecretKey) {
                passwordChangeMessage.textContent = 'Error: Current password is incorrect.';
                passwordChangeMessage.className = 'mt-2 text-sm text-red-600';
                passwordChangeMessage.classList.remove('hidden');
                changePasswordButton.textContent = 'Change Password';
                changePasswordButton.disabled = false;
                return;
            }

            if (newPass.length < 6) {
                passwordChangeMessage.textContent = 'Error: New password must be at least 6 characters long.';
                passwordChangeMessage.className = 'mt-2 text-sm text-red-600';
                passwordChangeMessage.classList.remove('hidden');
                changePasswordButton.textContent = 'Change Password';
                changePasswordButton.disabled = false;
                return;
            }

            try {
                await updateDoc(getConfigDocRef(userId), {
                    adminSecretKey: newPass
                });

                passwordChangeMessage.textContent = 'Password changed successfully! The new password is required for subsequent logins.';
                passwordChangeMessage.className = 'mt-2 text-sm text-green-600';
                passwordChangeMessage.classList.remove('hidden');
                showMessage("Admin password successfully changed!");

                currentPasswordInput.value = '';
                newPasswordInput.value = '';

            } catch (e) {
                console.error("Error changing password: ", e);
                passwordChangeMessage.textContent = 'Error saving new password: ' + e.message;
                passwordChangeMessage.className = 'mt-2 text-sm text-red-600';
                passwordChangeMessage.classList.remove('hidden');
            } finally {
                changePasswordButton.textContent = 'Change Password';
                changePasswordButton.disabled = false;
                setTimeout(() => passwordChangeMessage.classList.add('hidden'), 5000);
            }
        }

        window.handleTaskAction = async function(taskId, status) {
            if (!db) {
                showMessage("Database connection not ready.", true);
                return;
            }

            try {
                await updateDoc(getTaskDocRef(taskId), {
                    status: status,
                    reviewedBy: userId,
                    reviewedAt: new Date().toISOString()
                });
                showMessage(`Task ${taskId} set to ${status}!`);

            } catch (e) {
                console.error(`Error setting task status to ${status}:`, e);
                showMessage(`Failed to ${status} task.`, true);
            }
        }

        // --- Task Details Modal Logic ---

        function showTaskDetails(task) {
            modalDetailsContent.innerHTML = ''; // Clear previous content

            // Function to safely display data
            const detailItem = (label, value) => {
                const div = document.createElement('div');
                div.className = "p-3 bg-gray-50 rounded-lg";
                div.innerHTML = `<p class="text-xs font-semibold uppercase text-indigo-600">${label}</p><p class="mt-1 whitespace-pre-wrap">${value || 'N/A'}</p>`;
                return div;
            };

            // Order and display key fields
            modalDetailsContent.appendChild(detailItem("Task Title", task.title));
            modalDetailsContent.appendChild(detailItem("Description", task.description));
            modalDetailsContent.appendChild(detailItem("Requester Name (Mock Field)", task.requesterName || 'Unknown'));
            modalDetailsContent.appendChild(detailItem("Status", (task.status || 'pending').toUpperCase()));
            modalDetailsContent.appendChild(detailItem("Submitted At", new Date(task.createdAt || Date.now()).toLocaleString()));
            
            if (task.reviewedBy) {
                modalDetailsContent.appendChild(detailItem("Reviewed By User ID", task.reviewedBy));
                modalDetailsContent.appendChild(detailItem("Reviewed At", new Date(task.reviewedAt || Date.now()).toLocaleString()));
            }
            
            // Show the modal
            taskDetailsModal.classList.remove('invisible', 'opacity-0');
            taskDetailsModal.classList.add('visible', 'opacity-100');
            document.querySelector('#taskDetailsModal .modal-content').classList.remove('translate-y-4');
            document.querySelector('#taskDetailsModal .modal-content').classList.add('translate-y-0');
        }

        window.showTaskDetails = showTaskDetails; // Make available globally for inline onclick

        function hideTaskDetails() {
            // Hide the modal
            taskDetailsModal.classList.add('opacity-0');
            document.querySelector('#taskDetailsModal .modal-content').classList.add('translate-y-4');
            setTimeout(() => {
                taskDetailsModal.classList.add('invisible');
                document.querySelector('#taskDetailsModal .modal-content').classList.remove('translate-y-0');
            }, 300); // Wait for transition to complete
        }


        // --- UI Rendering ---

        function renderTasks(tasks) {
            tasksList.innerHTML = '';
            if (tasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-lg">No tasks currently submitted for review.</p>';
                return;
            }

            tasks.sort((a, b) => {
                const statusOrder = { 'pending': 0, 'rejected': 1, 'approved': 2 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
            });

            tasks.forEach(task => {
                const statusText = (task.status || 'pending').toUpperCase();

                const taskElement = document.createElement('div');
                taskElement.className = `card bg-white p-5 rounded-xl border border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center task-item status-${task.status || 'pending'}`;

                let actionButtons = '';
                if (task.status === 'pending' || !task.status) {
                    actionButtons = `
                        <div class="flex space-x-2 mt-3 sm:mt-0 flex-shrink-0">
                            <button onclick="showTaskDetails(${JSON.stringify(task).replace(/"/g, '&quot;')})" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-3 rounded-lg text-xs shadow-md">
                                Details
                            </button>
                            <button onclick="handleTaskAction('${task.id}', 'approved')" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-3 rounded-lg text-xs shadow-md">
                                Approve
                            </button>
                            <button onclick="handleTaskAction('${task.id}', 'rejected')" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-3 rounded-lg text-xs shadow-md">
                                Reject
                            </button>
                        </div>
                    `;
                } else {
                    actionButtons = `
                        <div class="flex space-x-2 mt-3 sm:mt-0 flex-shrink-0">
                             <button onclick="showTaskDetails(${JSON.stringify(task).replace(/"/g, '&quot;')})" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-3 rounded-lg text-xs shadow-md">
                                Details
                            </button>
                            <span class="text-sm font-bold text-gray-500 py-2 px-3 rounded-lg bg-gray-100 flex-shrink-0">
                                Reviewed (${statusText})
                            </span>
                        </div>
                    `;
                }

                taskElement.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <span class="text-xs font-semibold uppercase px-2 py-1 rounded-full ${task.status === 'approved' ? 'bg-green-100 text-green-700' : task.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${statusText}</span>
                        <p class="text-lg font-bold text-gray-800 mt-1 truncate">${task.title || 'Untitled Task'}</p>
                        <p class="text-sm text-gray-500 truncate mt-0.5">${task.description || 'No description provided.'}</p>
                        <p class="text-xs text-gray-400 mt-1">Submitted: ${new Date(task.createdAt).toLocaleString()}</p>
                    </div>
                    ${actionButtons}
                `;
                tasksList.appendChild(taskElement);
            });
        }

        // --- Event Listeners and Initial Load ---

        // Login form submission
        loginForm.addEventListener('submit', handleLogin);

        // Configuration form submission
        contentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newSettings = {
                mainTitle: mainTitleInput.value.trim()
            };
            saveConfig(newSettings);
        });

        // Password change form submission
        passwordChangeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            changePassword();
        });

        // Start the process
        window.onload = initializeFirebase;
    </script>

</body>
</html>


